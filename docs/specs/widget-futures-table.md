# Спецификация: виджет «Таблица фьючерсов» для Т-Инвестиции

## Что надо сделать
Виджет для торгового терминала Т-Инвестиции: таблица фьючерсов с колонками «название актива», «цена закрытия», «цена открытия», «изменение в %». В настройках — выбор отображаемых фьючерсов (список с галочками). Данные через T-Invest API (InstrumentsService, MarketDataService).

## Как это должно работать
- Пользователь открывает виджет → видит таблицу: актив (название, напр. GOLD 3-3.26 или тикер), цена закрытия (последняя дневная свеча), цена открытия (утренняя свеча дня), изменение в % (от цены закрытия; формула уточняется).
- В настройках — список фьючерсов с галочками; отображаются только выбранные.
- Данные подгружаются с T-Invest API: список фьючерсов (Futures), для каждого выбранного — дневные свечи (GetCandles, interval=day), берём последнюю полную свечу (open, close).

## Какие инструменты нам понадобятся
- T-Invest API (gRPC или REST): [developer.tbank.ru/invest](https://developer.tbank.ru/invest/api)
- Python: [invest-python](https://github.com/RussianInvestments/invest-python) (официальный SDK) или прямые gRPC/REST вызовы
- Бэкенд: небольшой сервер (Flask/FastAPI) для вызова API (токен не отдавать на фронт) и отдачи JSON
- Фронт: HTML/JS таблица + настройки (галочки), можно один HTML или отдельная папка static

## Какая информация нам потребуется
- [x] Цена закрытия = последняя дневная свеча (подтверждено)
- [x] Цена открытия = утренняя свеча (подтверждено)
- [ ] Формула %: от закрытия или от открытия — пользователь уточнит позже (временно: (close - open) / open * 100)
- [ ] Механизм встраивания виджета в терминал Т-Инвестиции — уточнить при необходимости

## Как должен выглядеть результат
- [ ] Таблица: столбец 1 — название актива (или тикер), 2 — цена закрытия, 3 — цена открытия, 4 — изменение %
- [ ] Настройки: список фьючерсов с галочками, сохранение выбора (localStorage или бэкенд)
- [ ] Данные берутся из T-Invest API (sandbox или prod по настройке)
- [ ] Токен и URL API из env, без хардкода

## Из каких шагов состоит реализация

### Шаг 1: Окружение и доступ к API
**Что сделать:** Создать виртуальное окружение, установить invest-python (или grpcio + proto), настроить чтение токена из env. Проверить доступ к Sandbox (GetCandles, Futures).
**Что проверить:** Получение списка фьючерсов и одной дневной свечи по figi/instrument_id.
**Логирование:** Логировать факт запросов к API (без токена и тел ответов).

### Шаг 2: Бэкенд — список фьючерсов и свечи
**Что сделать:** Эндпоинт списка фьючерсов (InstrumentsService.Futures). Эндпоинт данных для таблицы: по списку instrument_id запрашивать GetCandles (interval=day, последние 1–2 свечи), возвращать open, close, name/ticker.
**Что проверить:** Корректность Quotation → число (units + nano).
**Логирование:** Ошибки API, таймауты.

### Шаг 3: Фронт — таблица и настройки
**Что сделать:** HTML-страница: таблица (4 колонки), кнопка/панель «Настройки» → список фьючерсов с чекбоксами. Сохранение выбора (localStorage). Запрос к бэкенду за данными, отрисовка таблицы. Расчёт %: (close - open) / open * 100 (с возможностью смены формулы позже).
**Что проверить:** Отображение при пустом выборе, при одном/нескольких фьючерсах.
**Логирование:** Ошибки сетевых запросов в консоль.

### Шаг 4: Сборка и запуск
**Что сделать:** README с инструкцией: установка зависимостей, переменные (TINKOFF_INVEST_TOKEN, опционально SANDBOX=1), запуск бэкенда, открытие HTML в браузере.
**Что проверить:** Запуск на Windows (PowerShell).
**Логирование:** Старт сервера с указанием порта и режима (sandbox/prod).

## Как мы поймем, что все работает
- [ ] Все критерии приемки выполнены
- [ ] Таблица заполняется данными из API
- [ ] Настройки сохраняются и фильтруют строки таблицы
- [ ] Секреты не в коде, линтер без ошибок
- [ ] Документация (README, ROADMAP/DONE_LIST) обновлена

## Риски и митигация
- **Лимиты API:** не слать частые запросы; кэшировать список фьючерсов и свечи на 1–5 минут.
- **Нет данных по инструменту:** показывать «—» или «нет данных» в ячейке, не падать.
- **Токен истёк:** сообщение пользователю «проверьте токен» в UI или логах.

## Альтернативы
- Чистый фронт + CORS к T-Invest: токен пришлось бы вводить в браузере — небезопасно. **Выбран:** бэкенд-прокси с токеном из env.
- Только REST: у T-Invest есть REST-обёртки над gRPC; при использовании invest-python проще gRPC. **Выбран:** invest-python (gRPC).
