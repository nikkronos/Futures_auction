# Выполненные задачи — Damir

**Проект:** Виджет для торгового терминала Т-Инвестиции

---

## Сессия 12.02.2026 (вечер) — Стакан и оптимизация

### Выполнено:
1. **Добавлен режим стакана (OrderBook)**:
   - Новый endpoint `/api/orderbook` на сервере
   - Кнопка "Режим: Свечи / Стакан" для переключения
   - Таблица стакана: Bid, Ask, Цена аукц., Откл. %, Лоты
   - Автоопределение времени аукциона (МСК)
   - Индикатор аукциона (мигающий бейдж)

2. **Исправлена перегрузка сервера**:
   - Интервал обновления изменён с 1 сек на 5 сек
   - Увеличен TTL кэша свечей до 10 сек
   - Увеличен TTL кэша стакана до 5 сек

3. **Исправлен деплой**:
   - Синхронизированы папки `/root/Futures_auction` и `/opt/futures_auction`

### Время аукционов (МСК):
- **Открытие**: Пн-Пт 8:50-9:00, Сб-Вс 9:50-10:00
- **Закрытие**: 18:40-18:50 каждый день

---

## После теста аукциона — правки

1. **Переключение на 5 сек во время аукциона**  
   Время считалось по локальному времени браузера. Исправлено: московское время считается из UTC (UTC+3). После каждого обновления интервал пересчитывается, поэтому при наступлении аукциона переключение на 5 сек происходит вовремя.

2. **Отклонение в %**  
   В режиме стакана использовалась «цена закрытия» из ответа стакана. Отклонение унифицировано: везде считается от **вчерашней цены закрытия** (из дневных свечей) до цены аукциона. В `/api/orderbook` добавлена подстановка вчерашнего close из свечей.

3. **Точность цены**  
   Цена аукциона округляется до 2 знаков после запятой (копейки).

4. **Режим «Свечи»**  
   Данные те же: цена аукциона и отклонение считаются так же. Раньше во время аукциона обновление оставалось раз в 30 мин из‑за бага с временем; после исправления п.1 оба режима обновляются каждые 5 сек в окне аукциона.

5. **Лоты**  
   Объёмы берутся из API стакана (quantity по уровням). Если в терминале показываются другие цифры, возможно API отдаёт только **видимую часть айсберг-заявок**; полный объём по ним в API может быть недоступен. В коде добавлен комментарий об этом.

---

## 2026-02-12 — Сессия 1: MVP виджета

### Структура проекта
- Создана папка Damir с документами: ROADMAP, DONE_LIST, SESSION_SUMMARY, README, docs/
- Проект добавлен в глобальные документы: RULES_CURSOR, AGENT_PROMPTS, PROJECTS, QUICK_START_AGENT
- Damir добавлен в .gitignore (временно локально, потом отдельный репозиторий)

### Бэкенд (server.py)
- Flask-приложение с REST API
- `GET /api/futures` — список всех фьючерсов (376 шт. в sandbox)
- `GET /api/table?ids=...` — данные по выбранным инструментам (open, close, change %)
- Интеграция с T-Invest REST API (не SDK — SDK имеет сломанные зависимости)
- Автозагрузка токена из `env_vars.txt` (родительская папка)
- Отключена проверка SSL (обход корпоративного прокси/антивируса)

### Фронт (static/index.html)
- Таблица: актив, цена закрытия, цена открытия, изменение %
- Настройки: список фьючерсов с галочками, кнопки «Сохранить», «Выбрать все», «Снять все»
- Сохранение выбора в localStorage
- Тёмная тема (стиль под терминал)

### Тестирование
- Локальный запуск: `python server.py` → http://127.0.0.1:5000
- Sandbox-режим работает, данные загружаются

### Проблемы и решения
- SDK `tinkoff-investments` не устанавливается (сломанные зависимости на PyPI) → использован REST API напрямую
- SSL-ошибка при запросах к API → добавлен `verify=False`
- PowerShell не принимал токен через `$env:` → сервер читает из файла `env_vars.txt`

---

## 2026-02-12 — Сессия 2: Улучшения UI и кэширование

### Округление цен
- Умное форматирование: ≥1000 → 2 знака, ≥1 → 4 знака, <1 → 6 знаков
- Убираются лишние нули автоматически (17070.0000 → 17070)

### Автообновление
- Включено по умолчанию, интервал 5 секунд
- Кнопка «Авто: ВКЛ/ВЫКЛ» для переключения
- Отображается время последнего обновления

### Поиск в настройках
- Поле поиска по названию/тикеру
- Мгновенная фильтрация списка

### Фильтр по категориям
- Кнопки: Все, Металлы, Крипта, Индексы, Валюты, Товары, Акции
- Автоопределение категории по тикеру/названию
- Показывается количество фьючерсов в каждой категории
- Кнопка «Выбрать найденные» — выбрать все отфильтрованные

### Кэширование (server.py)
- Список фьючерсов: TTL 5 минут (редко меняется)
- Свечи: TTL 30 секунд (свежие, но без лишних запросов)
- Потокобезопасный in-memory кэш с `threading.Lock`
- Логирование: показывает сколько из кэша, сколько свежих

---

## 2026-02-12 — Сессия 3: Git и Деплой

### Git-репозиторий
- Создан публичный репозиторий: https://github.com/nikkronos/Futures_auction
- Добавлен `.gitignore` (Python, env, IDE)
- Все файлы запушены (17 файлов, 1146+ строк)

### Деплой на Timeweb
- Сервер: 81.200.146.32
- Путь: `/opt/futures_auction`
- Python venv: `/opt/futures_auction/.venv`
- Токен: `env_vars.txt` (SANDBOX=0 — боевой контур)
- systemd service: `futures_auction.service` (enabled, running)

### Результат
- **Виджет доступен 24/7:** http://81.200.146.32:5000

---

**Обновлено:** 2026-02-12
